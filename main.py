#!/usr/bin/env python3
# -*- coding: utf-8 -*-
"""
‚ñí‚ñí‚ñí‚ñí‚ñà‚ñà  ‚ñà‚ñà
    ‚ñà‚ñà        –ì–ò–¢–•–ê–ë: https://github.com/Divargia
‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñí‚ñí‚ñà‚ñà    –ê–í–¢–û–†: divargia
‚ñà‚ñà  ‚ñà‚ñà  ‚ñà‚ñà    –¢–ï–õ–ï–ì–†–ê–ú: @divargia
‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà  ‚ñà‚ñà

–°–ø–∞—Å–∏–±–æ –∑–∞ —Å–æ—Ç—Ä—É–¥–Ω–∏—á–µ—Å—Ç–≤–æ, —è –∫—É–ø–ª—é —Å–µ–±–µ –º–∞–π–Ω–∫—Ä–∞—Ñ—Ç!
                     --@divargia 

—É –º–µ–Ω—è –¥–µ–Ω—å –¥–æ –¥–µ–¥–ª–∞–π–Ω–∞, –Ω–∏–µ–≥–æ –Ω–µ —Ä–∞–±–æ—Ç–∞–µ—Ç, —Å–ø–µ—Ü –∫–∞—Ä—Ç–æ—á–∫–∏ —Å–ª–æ–º–∞–ª–∏—Å—å, –≤—Å—ë –ø–æ—à–ª–æ –ø–æ –ø–∏–∑–¥–µ, –±—ç–∫–µ–Ω–¥ –∑–ª–æ, –ø–∞–π—Ç–æ–Ω –∑–ª–æ, invalid syntax –Ω–∞—Ö—É–π –±–ª—è—Ç—å
"""

import sys
import os
import logging
import time
from pathlib import Path

# –î–æ–±–∞–≤–ª—è–µ–º —Ç–µ–∫—É—â—É—é –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏—é –≤ –ø—É—Ç—å –¥–ª—è –∏–º–ø–æ—Ä—Ç–æ–≤
sys.path.insert(0, os.path.dirname(os.path.abspath(__file__)))

from config import BOT_TOKEN, ADMIN_IDS, DATA_DIR
from bot import BunkerBot

logger = logging.getLogger(__name__)


def check_environment():
    """–ü—Ä–æ–≤–µ—Ä–∫–∞ –æ–∫—Ä—É–∂–µ–Ω–∏—è –∏ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏"""
    errors = []

    # –ü—Ä–æ–≤–µ—Ä—è–µ–º —Ç–æ–∫–µ–Ω –±–æ—Ç–∞
    if not BOT_TOKEN or BOT_TOKEN == 'YOUR_BOT_TOKEN_HERE':
        errors.append("‚ùå –ù–µ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω —Ç–æ–∫–µ–Ω –±–æ—Ç–∞. –£–∫–∞–∂–∏—Ç–µ BOT_TOKEN –≤ config.py –∏–ª–∏ –ø–µ—Ä–µ–º–µ–Ω–Ω–æ–π –æ–∫—Ä—É–∂–µ–Ω–∏—è.")

    # –ü—Ä–æ–≤–µ—Ä—è–µ–º ID –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞
    if ADMIN_IDS == 123456789:
        errors.append("‚ö†Ô∏è –ù–µ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω ID –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞. –£–∫–∞–∂–∏—Ç–µ ADMIN_ID –≤ config.py –∏–ª–∏ –ø–µ—Ä–µ–º–µ–Ω–Ω–æ–π –æ–∫—Ä—É–∂–µ–Ω–∏—è.")

    # –ü—Ä–æ–≤–µ—Ä—è–µ–º –ø—Ä–∞–≤–∞ –Ω–∞ –∑–∞–ø–∏—Å—å
    try:
        os.makedirs(DATA_DIR, exist_ok=True)
        test_file = os.path.join(DATA_DIR, 'test_write.tmp')
        with open(test_file, 'w') as f:
            f.write('test')
        os.remove(test_file)
    except Exception as e:
        errors.append(f"‚ùå –ù–µ—Ç –ø—Ä–∞–≤ –Ω–∞ –∑–∞–ø–∏—Å—å –≤ –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏—é {DATA_DIR}: {e}")

    return errors


def main():
    """–û—Å–Ω–æ–≤–Ω–∞—è —Ñ—É–Ω–∫—Ü–∏—è"""
    try:
        print("üöÄ –ó–∞–ø—É—Å–∫ Bunker RP Bot...")
        print("=" * 50)

        # –ü—Ä–æ–≤–µ—Ä—è–µ–º –æ–∫—Ä—É–∂–µ–Ω–∏–µ
        errors = check_environment()
        if errors:
            print("‚ö†Ô∏è –û–±–Ω–∞—Ä—É–∂–µ–Ω—ã –ø—Ä–æ–±–ª–µ–º—ã —Å –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–µ–π:")
            for error in errors:
                print(f"  {error}")

            if any("‚ùå" in error for error in errors):
                print("\nüí• –ö—Ä–∏—Ç–∏—á–µ—Å–∫–∏–µ –æ—à–∏–±–∫–∏! –ë–æ—Ç –Ω–µ –º–æ–∂–µ—Ç –±—ã—Ç—å –∑–∞–ø—É—â–µ–Ω.")
                return 1
            else:
                print("\n‚ö†Ô∏è –ü—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏—è –æ–±–Ω–∞—Ä—É–∂–µ–Ω—ã, –Ω–æ –±–æ—Ç –º–æ–∂–µ—Ç —Ä–∞–±–æ—Ç–∞—Ç—å.")
                time.sleep(3)

        # –°–æ–∑–¥–∞–µ–º –∏ –∑–∞–ø—É—Å–∫–∞–µ–º –±–æ—Ç–∞
        bot = BunkerBot()
        print("‚úÖ –ë–æ—Ç —É—Å–ø–µ—à–Ω–æ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω")
        print(f"üëë ID –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞: {ADMIN_IDS}")
        print(f"üìÅ –î–∏—Ä–µ–∫—Ç–æ—Ä–∏—è –¥–∞–Ω–Ω—ã—Ö: {DATA_DIR}")
        print("-" * 50)

        # –ü—Ä–æ–±–Ω–∞—è –æ—Ç–ø—Ä–∞–≤–∫–∞ —Å–æ–æ–±—â–µ–Ω–∏—è (–µ—Å–ª–∏ –Ω—É–∂–Ω–æ)
        # bot.bot.send_message(ADMIN_IDS, "–ë–æ—Ç —É—Å–ø–µ—à–Ω–æ –∑–∞–ø—É—â–µ–Ω!")

        # –ó–∞–ø—É—Å–∫–∞–µ–º –±–æ—Ç–∞
        bot.start_polling()

    except KeyboardInterrupt:
        print("\n‚èπÔ∏è –ü–æ–ª—É—á–µ–Ω —Å–∏–≥–Ω–∞–ª –æ—Å—Ç–∞–Ω–æ–≤–∫–∏...")
        if 'bot' in locals():
            bot.stop()
        print("‚úÖ –ë–æ—Ç –æ—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω")
        return 0

    except Exception as e:
        logger.error(f"–ö—Ä–∏—Ç–∏—á–µ—Å–∫–∞—è –æ—à–∏–±–∫–∞: {e}")
        print(f"\nüí• –ö—Ä–∏—Ç–∏—á–µ—Å–∫–∞—è –æ—à–∏–±–∫–∞: {e}")
        return 1


def install_requirements():
    """–£—Å—Ç–∞–Ω–æ–≤–∫–∞ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π"""
    try:
        import telebot
        print("‚úÖ pyTelegramBotAPI —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω")
    except ImportError:
        print("‚ùå pyTelegramBotAPI –Ω–µ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω")
        print("üí° –£—Å—Ç–∞–Ω–æ–≤–∏—Ç–µ –∫–æ–º–∞–Ω–¥–æ–π: pip install pyTelegramBotAPI")
        return False

    return True


def show_help():
    """–ü–æ–∫–∞–∑ —Å–ø—Ä–∞–≤a–∫–∏"""
    help_text = """
üéÆ Bunker RP Telegram Bot

üìã –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ:
  python main.py          - –ó–∞–ø—É—Å–∫ –±–æ—Ç–∞
  python main.py --help   - –≠—Ç–∞ —Å–ø—Ä–∞–≤–∫–∞
  python main.py --check  - –ü—Ä–æ–≤–µ—Ä–∫–∞ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏

‚öôÔ∏è –ù–∞—Å—Ç—Ä–æ–π–∫–∞:
1. –ü–æ–ª—É—á–∏—Ç–µ —Ç–æ–∫–µ–Ω –±–æ—Ç–∞ —É @BotFather
2. –£–∫–∞–∂–∏—Ç–µ —Ç–æ–∫–µ–Ω –≤ config.py (BOT_TOKEN) –∏–ª–∏ –ø–µ—Ä–µ–º–µ–Ω–Ω–æ–π –æ–∫—Ä—É–∂–µ–Ω–∏—è
3. –£–∫–∞–∂–∏—Ç–µ –≤–∞—à ID –≤ config.py (ADMIN_ID)
4. –ó–∞–ø—É—Å—Ç–∏—Ç–µ –±–æ—Ç–∞: python main.py

üìÅ –°—Ç—Ä—É–∫—Ç—É—Ä–∞ —Ñ–∞–π–ª–æ–≤:
  main.py         - –¢–æ—á–∫–∞ –≤—Ö–æ–¥–∞
  config.py       - –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è
  bot.py          - –û—Å–Ω–æ–≤–Ω–æ–π –∫–ª–∞—Å—Å –±–æ—Ç–∞
  game_manager.py - –ò–≥—Ä–æ–≤–∞—è –ª–æ–≥–∏–∫–∞
  player.py       - –ö–ª–∞—Å—Å –∏–≥—Ä–æ–∫–∞
  handlers.py     - –û–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ –∫–æ–º–∞–Ω–¥
  keyboards.py    - –ö–ª–∞–≤–∏–∞—Ç—É—Ä—ã
  timers.py       - –°–∏—Å—Ç–µ–º–∞ —Ç–∞–π–º–µ—Ä–æ–≤
  data/           - –î–∞–Ω–Ω—ã–µ –±–æ—Ç–∞
  data/cards/     - –ö–∞—Ä—Ç–æ—á–∫–∏ –∏–≥—Ä—ã

üéØ –ö–æ–º–∞–Ω–¥—ã –±–æ—Ç–∞:
  /start - –ì–ª–∞–≤–Ω–æ–µ –º–µ–Ω—é
  /game  - –ë—ã—Å—Ç—Ä–æ–µ —Å–æ–∑–¥–∞–Ω–∏–µ/–ø—Ä–∏—Å–æ–µ–¥–∏–Ω–µ–Ω–∏–µ –∫ –∏–≥—Ä–µ
  /help  - –°–ø—Ä–∞–≤–∫–∞
  /admin - –ü–∞–Ω–µ–ª—å –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞ (—Ç–æ–ª—å–∫–æ –¥–ª—è –∞–¥–º–∏–Ω–∞)
  /stop  - –û—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –∏–≥—Ä—É (–∞–¥–º–∏–Ω –∏–≥—Ä—ã)

üåê –ü–æ–¥–¥–µ—Ä–∂–∫–∞:
  - –°–æ–∑–¥–∞–≤–∞–π—Ç–µ –∏–≥—Ä—ã –≤ –≥—Ä—É–ø–ø–∞—Ö
  - –ü–æ–¥–¥–µ—Ä–∂–∫–∞ 3-8 –∏–≥—Ä–æ–∫–æ–≤
  - –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–µ —Ç–∞–π–º–µ—Ä—ã —Ñ–∞–∑
  - –°–∏—Å—Ç–µ–º–∞ –≥–æ–ª–æ—Å–æ–≤–∞–Ω–∏—è
  - –ù–∞—Å—Ç—Ä–∞–∏–≤–∞–µ–º—ã–µ –∫–∞—Ä—Ç–æ—á–∫–∏
"""
    print(help_text)


if __name__ == "__main__":
    # –û–±—Ä–∞–±–æ—Ç–∫–∞ –∞—Ä–≥—É–º–µ–Ω—Ç–æ–≤ –∫–æ–º–∞–Ω–¥–Ω–æ–π —Å—Ç—Ä–æ–∫–∏
    if len(sys.argv) > 1:
        if sys.argv[1] in ['--help', '-h', 'help']:
            show_help()
            sys.exit(0)
        elif sys.argv[1] in ['--check', '-c', 'check']:
            print("üîç –ü—Ä–æ–≤–µ—Ä–∫–∞ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏...")
            errors = check_environment()

            if not errors:
                print("‚úÖ –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è –∫–æ—Ä—Ä–µ–∫—Ç–Ω–∞!")

                if install_requirements():
                    print("‚úÖ –í—Å–µ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω—ã!")
                    print("üöÄ –ì–æ—Ç–æ–≤ –∫ –∑–∞–ø—É—Å–∫—É!")

            else:
                for error in errors:
                    print(f"  {error}")

            sys.exit(0)
        elif sys.argv[1] in ['--install', '-i', 'install']:
            print("üì¶ –ü—Ä–æ–≤–µ—Ä–∫–∞ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π...")
            install_requirements()
            sys.exit(0)

    # –ü—Ä–æ–≤–µ—Ä—è–µ–º –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –ø–µ—Ä–µ–¥ –∑–∞–ø—É—Å–∫–æ–º
    if not install_requirements():
        sys.exit(1)

    # –ó–∞–ø—É—Å–∫–∞–µ–º –±–æ—Ç–∞
    exit_code = main()
    sys.exit(exit_code)
